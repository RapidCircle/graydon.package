---
title: "Traversing economic activity hierarchies like NACE, SBI and SIC"
author: "Mark Zwart"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    css: graydon.css
    df_print: paged
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::knitr}
  %\VignetteEncoding{UTF-8}
---

* [Introduction](#introduction)
    - [Example data](#example_data)
* [Creating a economic activity graph](#create_graph)
    - [Visualizing the hierarchy](#visualize)
* [Rolling up the hierarchy on values](#roll_up)


```{r setup, include = FALSE}
library(magrittr)
library(ggplot2)
library(dplyr)
library(igraph)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# <a name="introduction"></a>Introduction

Our company databases have codes that indicate a company's economic activity. Economic activities are indicated by the NACE, SBI or SIC codes, depending on the country. Although this classification in helpful when looking at a client's customer portfolio, it contains so many groups and in some cases so little customers per group, that it is hard to make a proper portfolio analysis to spot a clients opportunities. With this package you can make use of the hierarchical nature of the economic activity coding to make less and larger groups.


First let's load the package:
```{r}
library(graydon.package)
```

### <a name="example_data"></a>The example data

The package contains a data frame, _tbl_SBI_count_ which is an example of the SBI codes completed with a count of the Dutch companies associated with that SBI code. The data frame contains the following columns:
```{r}
data.frame(`Column names` = names(tbl_SBI_count)) %>% 
  knitr::kable()
```

## <a name="create_graph"></a>Creating a economic activity graph

To do any calculation or plotting on the economic activity hierarchy, we have to create a graph. The parameters _col_id_ and _col_id_parent_ are the column names that contain the economic activity code and the parent code respectively.
```{r, message=FALSE, warning=FALSE}
graph_SBI <- create_economic_activity_graph(tbl_SBI_count, 
                                            col_id = "code_SBI", 
                                            col_id_parent = "code_SBI_parent")
```

### <a name="visualize"></a>Visualizing the hierarchy

By visualizing the hierarchy with the package's _plot_graydon_graph_ function we can see it is very complex:
```{r, message=FALSE, warning=FALSE, fig.height=6, fig.width=6}
plot_graydon_graph(graph_SBI, 
                   vertex.label = "", 
                   vertex.size = 3, 
                   edge.arrow.size = 0)
```

## <a name="roll_up"></a>Rolling up the hierarchy on values

A method for decreasing the complexity of the hierarchy is aggregating subcodes into higher up codes according whenever subnodes do not meet a minimum value requirement. Let's take the number of companies as an example: whenever the number of companies is lower than 5000, the companies with that subcode will get the code of one higher up in the hierarchy:

```{r, message=FALSE, warning=FALSE}
# graph_SBI_rolled <- roll_up_hierarchy_by_minimum(graph_tree = graph_SBI, 
#                                                  name_attribute = "qty_companies", 
#                                                  name_propagated = "qty_companies_cum", 
#                                                  threshold = 5000)
```

Maybe it doesn't look as simple as you might want it to be, but it is a lot simpler than you'd think. The smaller networks you now see are the 'translation' networks: they specify which subcode should be recoded to which 'higher up' code. The highest code get's a loop back to itself. So each 'subnetwork' in this plot is actually one code in the newly acquired aggregation. The 'higher up' codes are marked as orange in this graph.

```{r, message=FALSE, warning=FALSE, fig.height=6, fig.width=6}
# V(graph_SBI_rolled)$color <- ifelse(V(graph_SBI_rolled)$is_root, 1, 2)
# V(graph_SBI_rolled)$label <- ifelse(V(graph_SBI_rolled)$is_root, V(graph_SBI_rolled)$name, "")
# 
# plot_graydon_graph(graph_SBI_rolled, 
#                    #vertex.label = "", 
#                    vertex.size = 3, 
#                    edge.arrow.size = 0)
```

```{r}
# list_graphs <- decompose(graph_SBI_rolled)
# 
# idx_searched <- names(sapply(list_graphs, function(x) igraph::V(x)[1] ))
# idx_searched 
# 
# igraph::V(list_graphs[[3]])[1]
# plot_graydon_graph(list_graphs[[1]])
```


This graph is the basis of translating the original economic activity 
```{r}
# df_translation_codes <- hierarchy_as_data_frame(graph_SBI_rolled)
```

